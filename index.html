<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ–∫–∏–ª–∞ VS –¢—Ä–∏–∞—Ç–ª–æ–Ω</title>
  <style>
    /* ...–≤—Å–µ —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π... */
    /* –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Å—ë –æ—Ç :root –¥–æ .last-update */
  </style>
</head>
<body>
  <h1>–¢–µ–∫–∏–ª–∞ VS –¢—Ä–∏–∞—Ç–ª–æ–Ω</h1>

  <div id="error"></div>
  <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
  <div class="card">
    <div class="progress-container">
      <div class="progress-header">
        <span>Tequila</span>
        <span>–¶–µ–ª—å: ‚Ç¨150</span>
      </div>
      <div class="progress-bar">
        <div id="tequila-progress" class="progress-fill">0% (‚Ç¨0)</div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-header">
        <span>Triathlon</span>
        <span>–¶–µ–ª—å: ‚Ç¨800</span>
      </div>
      <div class="progress-bar">
        <div id="triathlon-progress" class="progress-fill">0% (‚Ç¨0)</div>
      </div>
    </div>
  </div>

  <!-- üîΩ –§–æ—Ä–º–∞ -->
  <div class="card">
    <select name="option" id="option">
      <option value="Tequila">Tequila</option>
      <option value="Triathlon">Triathlon</option>
    </select>

    <input name="amount" id="amount" type="number" placeholder="–°—É–º–º–∞ (‚Ç¨)" min="0" step="1" />

    <button onclick="submitData()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div class="last-update" id="last-update"></div>

  <!-- üîΩ –°–∫—Ä–∏–ø—Ç -->
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5o7UR_TzWiV_RqxLJ2tHSwp7aXeGTsYgbh-_CiePp_gLSg65z57OhbTZjdA2tlXMTbA/exec'; // –ó–ê–ú–ï–ù–ò –°–Æ–î–ê
    const GOALS = {
      Tequila: 150,
      Triathlon: 800
    };

    async function loadData() {
      try {
        showLoader(true);
        hideError();

        const url = new URL(SCRIPT_URL);
        url.searchParams.append('t', Date.now()); // –æ–±—Ö–æ–¥ –∫—ç—à–∞

        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);

        const data = await response.json();
        if (!data || typeof data !== 'object') throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");

        validateData(data);
        updateUI(data);
        updateLastUpdate();
      } catch (error) {
        showError(error.message);
      } finally {
        showLoader(false);
      }
    }

    async function submitData() {
      const option = document.getElementById('option').value;
      const amount = document.getElementById('amount').value;

      if (!amount || isNaN(amount) || amount <= 0) {
        showError("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
        return;
      }

      try {
        showLoader(true);
        hideError();

        const url = new URL(SCRIPT_URL);
        url.searchParams.append('option', option);
        url.searchParams.append('amount', amount);
        url.searchParams.append('t', Date.now());

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) throw new Error(data.error || "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏");

        document.getElementById('amount').value = '';
        showError("–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!", 'success');
        await loadData();
      } catch (e) {
        showError("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
      } finally {
        showLoader(false);
      }
    }

    function validateData(data) {
      if (typeof data.Tequila !== 'number' || typeof data.Triathlon !== 'number') {
        throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–≤–µ—Ç–µ");
      }
    }

    function updateUI(data) {
      updateProgressBar('tequila', data.Tequila, GOALS.Tequila);
      updateProgressBar('triathlon', data.Triathlon, GOALS.Triathlon);
    }

    function updateProgressBar(type, value, goal) {
      const numericValue = parseFloat(value) || 0;
      const numericGoal = parseFloat(goal) || 1;

      const percent = Math.min((numericValue / numericGoal) * 100, 100);
      const displayPercent = percent.toFixed(1);

      const element = document.getElementById(`${type}-progress`);
      if (element) {
        element.style.width = `${percent}%`;
        element.textContent = `${displayPercent}% (‚Ç¨${numericValue.toFixed(2)})`;
      }
    }

    function updateLastUpdate() {
      const element = document.getElementById('last-update');
      if (element) {
        element.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString();
      }
    }

    function showLoader(show) {
      const element = document.getElementById('loader');
      if (element) {
        element.style.display = show ? 'block' : 'none';
      }
    }

    function showError(message, type = 'error') {
      const element = document.getElementById('error');
      if (!element) return;

      element.textContent = message;
      element.className = type;
      element.style.display = 'block';

      if (type === 'success') {
        setTimeout(() => element.style.display = 'none', 3000);
      }
    }

    function hideError() {
      const element = document.getElementById('error');
      if (element) {
        element.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
